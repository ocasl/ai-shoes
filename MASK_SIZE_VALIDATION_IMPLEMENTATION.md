# è’™ç‰ˆå°ºå¯¸éªŒè¯åŠŸèƒ½å®ç°æ€»ç»“

## é—®é¢˜èƒŒæ™¯
åœ¨AIé‹æ¬¾è®¾è®¡ç³»ç»Ÿä¸­ï¼Œå›¾ç”Ÿå›¾åŠŸèƒ½éœ€è¦è°ƒç”¨ComfyUIè¿›è¡Œå›¾åƒå¤„ç†ã€‚**è’™ç‰ˆå›¾ç‰‡å’ŒåŸå›¾å¿…é¡»å¤§å°ç›¸ç­‰æ‰å¯ä»¥è°ƒç”¨ComfyUI**ï¼Œå¦åˆ™ä¼šå¯¼è‡´ï¼š
- ComfyUIè°ƒç”¨å¤±è´¥
- å›¾åƒå¤„ç†ç»“æœå¼‚å¸¸
- è’™ç‰ˆåŒºåŸŸå®šä½é”™è¯¯

## è§£å†³æ–¹æ¡ˆ

### 1. æ ¸å¿ƒå·¥å…·ç±»ï¼šMaskUploadUtils

ä½ç½®ï¼š`src/utils/maskUtils.ts`

#### æ–°å¢åŠŸèƒ½ï¼š
- **å°ºå¯¸éªŒè¯**ï¼š`validateMaskSize()` - éªŒè¯è’™ç‰ˆä¸åŸå›¾å°ºå¯¸æ˜¯å¦åŒ¹é…
- **æ™ºèƒ½è°ƒæ•´**ï¼š`resizeMaskToMatch()` - è‡ªåŠ¨è°ƒæ•´è’™ç‰ˆå°ºå¯¸ä»¥åŒ¹é…åŸå›¾
- **æ™ºèƒ½ä¸Šä¼ **ï¼š`uploadMaskCanvasWithValidation()` - å¸¦éªŒè¯çš„è’™ç‰ˆä¸Šä¼ 

#### å…³é”®ç‰¹æ€§ï¼š
```typescript
// è‡ªåŠ¨éªŒè¯å’Œè°ƒæ•´è’™ç‰ˆå°ºå¯¸
const maskId = await MaskUploadUtils.uploadMaskCanvasWithValidation(
  maskCanvas,           // ç”¨æˆ·ç»˜åˆ¶çš„è’™ç‰ˆcanvas
  originalImageId,      // åŸå›¾ID
  originalImageUrl,     // åŸå›¾URLï¼ˆç”¨äºè·å–å°ºå¯¸ï¼‰
  true                  // è‡ªåŠ¨è°ƒæ•´å°ºå¯¸
);
```

### 2. éªŒè¯ç»“æœæ¥å£

```typescript
interface MaskSizeValidationResult {
  isValid: boolean;                           // å°ºå¯¸æ˜¯å¦åŒ¹é…
  originalSize: { width: number; height: number }; // åŸå›¾å°ºå¯¸
  maskSize: { width: number; height: number };     // è’™ç‰ˆå°ºå¯¸
  needsResize: boolean;                       // æ˜¯å¦éœ€è¦è°ƒæ•´å°ºå¯¸
  errorMessage?: string;                      // é”™è¯¯ä¿¡æ¯
}
```

### 3. é›†æˆåˆ°ImageWorkspaceç»„ä»¶

ä½ç½®ï¼š`src/components/design/ImageWorkspace.vue`

#### æ›´æ–°å†…å®¹ï¼š
- åœ¨`confirmMask()`æ–¹æ³•ä¸­é›†æˆäº†æ–°çš„éªŒè¯å·¥å…·
- è‡ªåŠ¨éªŒè¯è’™ç‰ˆå°ºå¯¸å¹¶åœ¨éœ€è¦æ—¶è°ƒæ•´
- æä¾›è¯¦ç»†çš„æ—¥å¿—è®°å½•å’Œé”™è¯¯å¤„ç†

#### å…³é”®æ”¹è¿›ï¼š
```typescript
// ä½¿ç”¨å¢å¼ºç‰ˆè’™ç‰ˆä¸Šä¼ å·¥å…·ï¼Œç¡®ä¿å°ºå¯¸åŒ¹é…
const maskId = await MaskUploadUtils.uploadMaskCanvasWithValidation(
  aiMaskCanvas,
  maskImageId,
  currentImageUrl,
  true // è‡ªåŠ¨è°ƒæ•´å°ºå¯¸
);
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•ï¼ˆæ¨èï¼‰
```typescript
import { MaskUploadUtils } from '../utils/maskUtils';

try {
  const maskId = await MaskUploadUtils.uploadMaskCanvasWithValidation(
    maskCanvas,           // ç”¨æˆ·ç»˜åˆ¶çš„è’™ç‰ˆcanvas
    originalImageId,      // åŸå›¾ID
    originalImageUrl,     // åŸå›¾URLï¼ˆç”¨äºè·å–å°ºå¯¸ï¼‰
    true                  // è‡ªåŠ¨è°ƒæ•´å°ºå¯¸ï¼ˆé»˜è®¤trueï¼‰
  );
  
  console.log('è’™ç‰ˆä¸Šä¼ æˆåŠŸï¼ŒID:', maskId);
} catch (error) {
  console.error('è’™ç‰ˆä¸Šä¼ å¤±è´¥:', error.message);
}
```

### ä»…éªŒè¯å°ºå¯¸
```typescript
const validation = await MaskUploadUtils.validateMaskSize(maskCanvas, originalImageUrl);

if (!validation.isValid) {
  console.log('å°ºå¯¸ä¸åŒ¹é…:', validation.errorMessage);
  
  if (validation.needsResize) {
    // æ‰‹åŠ¨è°ƒæ•´å°ºå¯¸
    const resizedCanvas = MaskUploadUtils.resizeMaskToMatch(
      maskCanvas,
      validation.originalSize.width,
      validation.originalSize.height
    );
  }
}
```

## éªŒè¯æµç¨‹

1. **è·å–åŸå›¾å°ºå¯¸**ï¼šé€šè¿‡åŸå›¾URLåŠ è½½å›¾ç‰‡å¹¶è·å–è‡ªç„¶å°ºå¯¸
2. **æ¯”è¾ƒå°ºå¯¸**ï¼šå¯¹æ¯”è’™ç‰ˆcanvaså°ºå¯¸ä¸åŸå›¾å°ºå¯¸
3. **è‡ªåŠ¨è°ƒæ•´**ï¼šå¦‚æœå°ºå¯¸ä¸åŒ¹é…ä¸”å¯ç”¨è‡ªåŠ¨è°ƒæ•´ï¼Œåˆ›å»ºæ–°çš„åŒ¹é…å°ºå¯¸çš„canvas
4. **ä¸Šä¼ è’™ç‰ˆ**ï¼šä½¿ç”¨è°ƒæ•´åçš„canvasä¸Šä¼ è’™ç‰ˆ
5. **åé¦ˆç»“æœ**ï¼šè¿”å›ä¸Šä¼ åçš„å›¾ç‰‡IDå’Œç›¸å…³ä¿¡æ¯

## æ—¥å¿—è®°å½•

ç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•éªŒè¯è¿‡ç¨‹ï¼š
```
ğŸ” è’™ç‰ˆå°ºå¯¸éªŒè¯: {
  åŸå›¾å°ºå¯¸: { width: 1024, height: 768 },
  è’™ç‰ˆå°ºå¯¸: { width: 800, height: 600 },
  å°ºå¯¸åŒ¹é…: false,
  éœ€è¦è°ƒæ•´: true
}

âš ï¸ è’™ç‰ˆå°ºå¯¸ä¸åŒ¹é…ï¼Œæ­£åœ¨è‡ªåŠ¨è°ƒæ•´...
ğŸ”§ è’™ç‰ˆå°ºå¯¸è°ƒæ•´: 800x600 â†’ 1024x768
âœ… è’™ç‰ˆå°ºå¯¸å·²è‡ªåŠ¨è°ƒæ•´ä¸ºä¸åŸå›¾ä¸€è‡´
```

## é”™è¯¯å¤„ç†

- **æ— æ³•è·å–åŸå›¾å°ºå¯¸**ï¼šè®°å½•è­¦å‘Šä½†ä¸é˜»æ­¢ä¸Šä¼ 
- **å°ºå¯¸ä¸åŒ¹é…ä¸”ç¦ç”¨è‡ªåŠ¨è°ƒæ•´**ï¼šæŠ›å‡ºé”™è¯¯å¹¶æç¤ºç”¨æˆ·
- **Canvasæ“ä½œå¤±è´¥**ï¼šæä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯
- **ç½‘ç»œä¸Šä¼ å¤±è´¥**ï¼šå›é€€åˆ°æœ¬åœ°å¤„ç†

## å…¼å®¹æ€§

- **å‘åå…¼å®¹**ï¼šä¿ç•™åŸæœ‰çš„`uploadMaskCanvas()`æ–¹æ³•
- **æ¸è¿›å¢å¼º**ï¼šæ–°åŠŸèƒ½ä¸å½±å“ç°æœ‰ä»£ç 
- **å¯é€‰éªŒè¯**ï¼šå¯ä»¥é€‰æ‹©æ˜¯å¦å¯ç”¨è‡ªåŠ¨è°ƒæ•´

## ç¤ºä¾‹ä»£ç 

å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹è¯·å‚è€ƒï¼š`src/examples/MaskSizeValidationExample.vue`

## æœ€ä½³å®è·µ

1. **æ€»æ˜¯ä½¿ç”¨éªŒè¯ç‰ˆæœ¬**ï¼šä¼˜å…ˆä½¿ç”¨`uploadMaskCanvasWithValidation()`
2. **æä¾›åŸå›¾URL**ï¼šç¡®ä¿éªŒè¯çš„å‡†ç¡®æ€§
3. **å¯ç”¨è‡ªåŠ¨è°ƒæ•´**ï¼šè®©ç³»ç»Ÿè‡ªåŠ¨å¤„ç†å°ºå¯¸ä¸åŒ¹é…é—®é¢˜
4. **å¤„ç†é”™è¯¯**ï¼šæ•è·å¹¶é€‚å½“å¤„ç†å¯èƒ½çš„éªŒè¯é”™è¯¯
5. **æŸ¥çœ‹æ—¥å¿—**ï¼šåˆ©ç”¨è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯è¿›è¡Œè°ƒè¯•

## æŠ€æœ¯ç»†èŠ‚

- **å°ºå¯¸è·å–**ï¼šä½¿ç”¨Imageå¯¹è±¡çš„naturalWidth/naturalHeight
- **Canvasè°ƒæ•´**ï¼šä½¿ç”¨drawImageè¿›è¡Œæ™ºèƒ½ç¼©æ”¾
- **è·¨åŸŸå¤„ç†**ï¼šè®¾ç½®crossOrigin='anonymous'
- **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶æ¸…ç†ä¸´æ—¶åˆ›å»ºçš„canvaså¯¹è±¡

## æµ‹è¯•éªŒè¯

ç³»ç»Ÿå·²åœ¨ä»¥ä¸‹åœºæ™¯ä¸‹æµ‹è¯•ï¼š
- âœ… å°ºå¯¸å®Œå…¨åŒ¹é…çš„è’™ç‰ˆ
- âœ… éœ€è¦æ”¾å¤§çš„è’™ç‰ˆ
- âœ… éœ€è¦ç¼©å°çš„è’™ç‰ˆ
- âœ… è·¨åŸŸå›¾ç‰‡å¤„ç†
- âœ… ç½‘ç»œé”™è¯¯å¤„ç†
- âœ… Canvasæ“ä½œå¼‚å¸¸å¤„ç†

é€šè¿‡è¿™ä¸ªå®ç°ï¼Œç¡®ä¿äº†**å›¾ç”Ÿå›¾åŠŸèƒ½ä¸­è’™ç‰ˆå›¾ç‰‡å’ŒåŸå›¾å¤§å°ç›¸ç­‰**ï¼Œæ»¡è¶³äº†ComfyUIçš„è°ƒç”¨è¦æ±‚ã€‚